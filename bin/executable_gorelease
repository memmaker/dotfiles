#!/bin/bash

createZIP() {
    FILE="$1"
    zip "${FILE}.zip" "${FILE}"
    rm "${FILE}"
}

createTGZ() {
    FILE="$1"
    tar czf "${FILE}.tgz" "${FILE}"
    rm "${FILE}"
}


NAME="$1"
shift

VERSION=$(semver get release)

if [ -d "release" ]; then
    echo "warning: release dir exists. Removing all files!"
    rm -rfi release/*
else
    mkdir release
fi

CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o release/"${NAME}_${VERSION}_linux_amd64" -trimpath -ldflags '-s -w' "$@"
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o release/"${NAME}_${VERSION}_linux_arm64" -trimpath -ldflags '-s -w' "$@"
CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o release/"${NAME}_${VERSION}_darwin_amd64" -trimpath -ldflags '-s -w' "$@"
CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build  -o release/"${NAME}_${VERSION}_darwin_arm64" -trimpath -ldflags '-s -w' "$@"
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o release/"${NAME}_${VERSION}_windows_amd64.exe" -trimpath -ldflags '-s -w' "$@"

cd release || exit
for FILE in "${NAME}"_*
do
    createTGZ "${FILE}"
done
